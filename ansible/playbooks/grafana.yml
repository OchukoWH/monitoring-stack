---
- name: Install and Configure Grafana
  hosts: grafana
  become: true
  vars:
    grafana_version: "12.2.1"
    grafana_deb_file: "grafana-enterprise_{{ grafana_version }}_18655849634_linux_amd64.deb"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required dependencies
      apt:
        name:
          - adduser
          - libfontconfig1
          - musl
        state: present

    - name: Download Grafana Enterprise package
      get_url:
        url: "https://dl.grafana.com/grafana-enterprise/release/{{ grafana_version }}/{{ grafana_deb_file }}"
        dest: "/tmp/{{ grafana_deb_file }}"
        mode: '0644'

    - name: Install Grafana Enterprise package
      apt:
        deb: "/tmp/{{ grafana_deb_file }}"
        state: present

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start Grafana service
      systemd:
        name: grafana-server
        enabled: yes
        state: started

    - name: Wait for Grafana to start
      wait_for:
        port: 3000
        delay: 10
        timeout: 60

    - name: Verify Grafana is running
      systemd:
        name: grafana-server
      register: grafana_status

    - name: Display Grafana status
      debug:
        msg: "Grafana service is {{ grafana_status.status.ActiveState }}"

    - name: Display Grafana information
      debug:
        msg:
          - "Grafana Enterprise installed successfully!"
          - "Config: /etc/grafana/grafana.ini"
          - "Data: /var/lib/grafana/"
          - "Service: systemctl status grafana-server"
          - "Access Grafana UI at http://{{ ansible_default_ipv4.address }}:3000 (default admin/admin)"

    - name: Clean up temporary files
      file:
        path: "/tmp/{{ grafana_deb_file }}"
        state: absent

